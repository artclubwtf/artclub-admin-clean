{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/apps/artclub-admin-clean/middleware.ts"],"sourcesContent":["import { getToken } from \"next-auth/jwt\";\nimport type { NextRequest } from \"next/server\";\nimport { NextResponse } from \"next/server\";\n\nfunction redirectToLogin(req: NextRequest) {\n  const callbackUrl = req.nextUrl.pathname + req.nextUrl.search;\n  const loginUrl = new URL(\"/login\", req.url);\n  loginUrl.searchParams.set(\"callbackUrl\", callbackUrl);\n  return NextResponse.redirect(loginUrl);\n}\n\nexport async function middleware(req: NextRequest) {\n  const { pathname } = req.nextUrl;\n\n  const isApiPath = pathname.startsWith(\"/api\");\n  const isAdminPath = pathname.startsWith(\"/admin\");\n  const isArtistPath = pathname.startsWith(\"/artist\");\n\n  if (isApiPath) {\n    const allowedApi =\n      pathname.startsWith(\"/api/auth\") ||\n      pathname === \"/api/setup\" ||\n      pathname.startsWith(\"/api/setup/\") ||\n      pathname === \"/api/account/change-password\" ||\n      pathname.startsWith(\"/api/account/change-password/\") ||\n      pathname.startsWith(\"/api/applications\") ||\n      pathname === \"/api/shopify/files/upload\" ||\n      pathname === \"/api/shopify/files/resolve\" ||\n      pathname === \"/api/shopify/resolve-media\" ||\n      pathname.startsWith(\"/api/artist-onboarding\");\n\n    if (allowedApi) return NextResponse.next();\n\n    try {\n      const token = await getToken({ req, secret: process.env.NEXTAUTH_SECRET });\n      if (!token) {\n        return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n      }\n\n      if (pathname.startsWith(\"/api/uploads\")) {\n        if (token.role === \"team\" || token.role === \"artist\") {\n          return NextResponse.next();\n        }\n        return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\n      }\n\n      const isArtistApi = pathname === \"/api/artist\" || pathname.startsWith(\"/api/artist/\");\n      if (isArtistApi) {\n        if (token.role !== \"artist\" || !token.artistId) {\n          return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\n        }\n        return NextResponse.next();\n      }\n\n      if (token.role !== \"team\") {\n        return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\n      }\n      return NextResponse.next();\n    } catch (err) {\n      console.error(\"Middleware auth error (api)\", err);\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n  }\n\n  if (!isAdminPath && !isArtistPath) return NextResponse.next();\n\n  try {\n    const token = await getToken({ req, secret: process.env.NEXTAUTH_SECRET });\n    if (!token) return redirectToLogin(req);\n\n    if (isAdminPath) {\n      if (token.role !== \"team\") {\n        const fallback = token.role === \"artist\" ? \"/artist\" : \"/login\";\n        return NextResponse.redirect(new URL(fallback, req.url));\n      }\n      return NextResponse.next();\n    }\n\n    if (isArtistPath) {\n      if (token.role !== \"artist\") {\n        const fallback = token.role === \"team\" ? \"/admin\" : \"/login\";\n        return NextResponse.redirect(new URL(fallback, req.url));\n      }\n\n      const pendingRegistrationId = (token as { pendingRegistrationId?: string }).pendingRegistrationId;\n      if (!token.artistId && pendingRegistrationId) {\n        return NextResponse.redirect(new URL(`/apply/${pendingRegistrationId}/dashboard`, req.url));\n      }\n\n      if (token.mustChangePassword && !pathname.startsWith(\"/artist/change-password\")) {\n        const changeUrl = new URL(\"/artist/change-password\", req.url);\n        changeUrl.searchParams.set(\"callbackUrl\", pathname + req.nextUrl.search);\n        return NextResponse.redirect(changeUrl);\n      }\n\n      return NextResponse.next();\n    }\n  } catch (err) {\n    console.error(\"Middleware auth error\", err);\n    return redirectToLogin(req);\n  }\n\n  return NextResponse.next();\n}\n\nexport const config = {\n  matcher: [\"/admin/:path*\", \"/artist/:path*\", \"/api/:path*\"],\n};\n"],"names":[],"mappings":"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"}}]
}